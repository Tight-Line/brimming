<% content_for(:title) { "#{@question.title} - Brimming" } %>

<article class="question-detail">
  <div class="question-content-wrapper">
    <%= render 'votes/vote_buttons', votable: @question, votable_type: 'question' %>

    <div class="question-content">
      <div class="question-header">
        <h1 class="question-title"><%= @question.title %></h1>
        <div class="question-meta">
          <% if @question.system_generated? %>
            <span class="badge badge-info">Official FAQ</span>
            <span>by <%= render 'shared/user_badge', user: @question.author %></span>
            <% if @question.sponsored_by.present? %>
              <span class="sponsored-by">(sponsored by <%= render 'shared/user_badge', user: @question.sponsored_by %>)</span>
            <% end %>
          <% else %>
            <span>Asked by <%= render 'shared/user_badge', user: @question.author %></span>
          <% end %>
          <span><%= time_ago_in_words(@question.created_at) %> ago</span>
          <% if @question.edited? %>
            <span>(edited <%= time_ago_in_words(@question.edited_at) %> ago)</span>
          <% end %>
          <span>in <span class="space"><%= link_to @question.space.name, space_path(@question.space) %></span></span>
          <%= render "shared/subscribe_button", space: @question.space, size: "btn-small" %>
          <% if @question.views_count > 0 %>
            <span><%= @question.views_count %> <%= "view".pluralize(@question.views_count) %></span>
          <% end %>
          <span class="question-actions">
            <%= render 'bookmarks/bookmark_button', bookmarkable: @question %>
            <% if user_signed_in? %>
              <% if @question.owned_by?(current_user) %>
                <%= link_to "Edit", edit_question_path(@question), class: "btn-link" %>
                <%= button_to "Delete", question_path(@question), method: :delete,
                    class: "btn-link btn-link-danger",
                    form: { data: { turbo: false }, onsubmit: "return confirm('Are you sure you want to delete this question?')" } %>
              <% end %>
              <% if current_user.can_moderate?(@question.space) %>
                <%= button_to "Permanently Delete", hard_delete_question_path(@question), method: :delete,
                    class: "btn-link btn-link-danger",
                    form: { data: { turbo: false }, onsubmit: "return confirm('Are you sure you want to PERMANENTLY delete this question and all its answers and comments? This cannot be undone.')" } %>
              <% end %>
            <% end %>
          </span>
        </div>
      </div>
      <div class="question-body markdown-body">
        <%= markdown(@question.body) %>
      </div>


      <%= render 'comments/comments_section', comments: @question_comments, commentable: @question %>
    </div>
  </div>
</article>

<section class="answers-section">
  <div class="answers-header">
    <h2><%= @answers.count %> <%= "Answer".pluralize(@answers.count) %></h2>
  </div>

  <% if @answers.any? %>
    <% @answers.each do |answer| %>
      <div class="answer-item <%= 'solved' if answer.is_correct? %> <%= 'answer-deleted' if answer.deleted? %>" id="answer-<%= answer.id %>">
        <% if answer.deleted? %>
          <div class="answer-content-wrapper">
            <div class="answer-content">
              <div class="answer-body answer-deleted-message">
                <em>This answer has been deleted.</em>
              </div>
              <% if user_signed_in? && current_user.can_moderate?(answer.space) %>
                <div class="answer-meta moderator-actions">
                  <%= button_to "Permanently Delete", hard_delete_answer_path(answer), method: :delete,
                      class: "btn-link btn-link-danger",
                      form: { data: { turbo: false }, onsubmit: "return confirm('Are you sure you want to PERMANENTLY delete this answer and all its comments? This cannot be undone.')" } %>
                </div>
              <% end %>
              <% answer_comments = answer.comments.top_level.sort_by(&:created_at) %>
              <%= render 'comments/comments_section', comments: answer_comments, commentable: answer %>
            </div>
          </div>
        <% else %>
          <div class="answer-content-wrapper">
            <%= render 'votes/vote_buttons', votable: answer, votable_type: 'answer' %>

            <div class="answer-content">
              <div class="answer-body markdown-body">
                <%= markdown(answer.body) %>
              </div>
              <% if answer.answer_sources.any? %>
                <%= render 'answers/sources', answer: answer %>
              <% end %>
              <div class="answer-meta">
                <% if answer.system_generated? %>
                  <span class="badge badge-info">Official Answer</span>
                  <span>by <%= render 'shared/user_badge', user: answer.author %></span>
                  <% if answer.sponsored_by.present? %>
                    <span class="sponsored-by">(sponsored by <%= render 'shared/user_badge', user: answer.sponsored_by %>)</span>
                  <% end %>
                <% else %>
                  <span>by <%= render 'shared/user_badge', user: answer.author %></span>
                <% end %>
                <span><%= time_ago_in_words(answer.created_at) %> ago</span>
                <% if answer.edited? %>
                  <span>(edited <%= time_ago_in_words(answer.edited_at) %> ago)</span>
                <% end %>
                <% if answer.is_correct? %>
                  <span class="badge badge-success">Solved</span>
                <% end %>
                <span class="answer-actions">
                  <%= render 'bookmarks/bookmark_button', bookmarkable: answer %>
                  <% if user_signed_in? %>
                    <% if answer.owned_by?(current_user) %>
                      <%= link_to "Edit", edit_answer_path(answer), class: "btn-link" %>
                      <%= button_to "Delete", answer_path(answer), method: :delete,
                          class: "btn-link btn-link-danger",
                          form: { data: { turbo: false }, onsubmit: "return confirm('Are you sure you want to delete this answer?')" } %>
                    <% end %>
                    <% if current_user.can_moderate?(answer.space) %>
                      <%= button_to "Permanently Delete", hard_delete_answer_path(answer), method: :delete,
                          class: "btn-link btn-link-danger",
                          form: { data: { turbo: false }, onsubmit: "return confirm('Are you sure you want to PERMANENTLY delete this answer and all its comments? This cannot be undone.')" } %>
                    <% end %>
                  <% end %>
                </span>
              </div>

              <% answer_comments = answer.comments.top_level.sort_by(&:created_at) %>
              <%= render 'comments/comments_section', comments: answer_comments, commentable: answer %>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>
  <% else %>
    <div class="empty-state">
      <p>No answers yet. Be the first to answer!</p>
    </div>
  <% end %>
</section>

<section class="answer-form-section">
  <% if user_signed_in? %>
    <%= render "answers/form", question: @question, answer: Answer.new %>
  <% else %>
    <div class="card">
      <div class="empty-state">
        <p>
          <button type="button" class="btn btn-primary" data-action="modal#open">Log in</button>
          to post an answer
        </p>
      </div>
    </div>
  <% end %>
</section>
