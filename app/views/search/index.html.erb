<%# TODO: i18n %>
<% content_for(:title) { "Search - Brimming" } %>

<div class="page-header">
  <h1>Search</h1>
</div>

<div class="search-container">
  <%= form_with url: search_path, method: :get, class: "search-form", data: { turbo: false } do |f| %>
    <div class="search-input-wrapper">
      <input type="search"
             name="q"
             value="<%= @query %>"
             placeholder="Search questions..."
             class="form-control search-input"
             autofocus>
      <%= f.submit "Search", class: "btn btn-primary" %>
    </div>

    <div class="search-filters">
      <% if @space %>
        <span class="search-filter-active">
          <%# TODO: i18n %>
          in <%= link_to @space.name, space_path(@space) %>
          <%= link_to "x", search_path(q: @query, user: @user&.username, tags: @tags, sort: @sort), class: "filter-remove" %>
        </span>
      <% end %>

      <% if @user %>
        <span class="search-filter-active">
          <%# TODO: i18n %>
          by <%= link_to @user.username, user_path(@user) %>
          <%= link_to "x", search_path(q: @query, space: @space&.slug, tags: @tags, sort: @sort), class: "filter-remove" %>
        </span>
      <% end %>

      <% @tags.each do |tag| %>
        <span class="search-filter-active tag-filter">
          <%= tag %>
          <%= link_to "x", search_path(q: @query, space: @space&.slug, user: @user&.username, tags: @tags - [tag], sort: @sort), class: "filter-remove" %>
        </span>
      <% end %>
    </div>

    <% if @query.present? || @space.present? || @user.present? || @tags.any? %>
      <div class="search-sort">
        <%# TODO: i18n %>
        <span class="sort-label">Sort by:</span>
        <% sort_options = [
          ["Relevance", "relevance"],
          ["Newest", "newest"],
          ["Oldest", "oldest"],
          ["Most Votes", "votes"],
          ["Recent Activity", "activity"]
        ] %>
        <% sort_options.each do |label, value| %>
          <% if @sort == value || (@sort.blank? && value == "relevance") %>
            <span class="sort-option active"><%= label %></span>
          <% else %>
            <%= link_to label, search_path(q: @query, space: @space&.slug, user: @user&.username, tags: @tags, sort: value), class: "sort-option" %>
          <% end %>
        <% end %>
      </div>
    <% end %>
  <% end %>
</div>

<% if @query.present? && current_user && LlmService.available? %>
  <div id="ai-answer-panel" class="ai-answer-panel" data-query="<%= @query %>" data-space="<%= @space&.slug %>">
    <div class="ai-answer-header">
      <span class="ai-answer-icon">‚ú®</span>
      <span class="ai-answer-title">AI Answer</span>
      <span class="ai-answer-badge">Beta</span>
    </div>
    <div class="ai-answer-content-wrapper">
      <div class="ai-answer-content">
        <div class="ai-answer-loading">
          <div class="loading-dots">
            <span></span><span></span><span></span>
          </div>
          <span class="loading-text">Generating answer...</span>
        </div>
      </div>
      <div class="ai-answer-fade"></div>
    </div>
    <button class="ai-answer-expand" style="display: none;">Show more</button>
  </div>
<% end %>

<div class="card">
  <% if @results && @results.hits.any? %>
    <div class="search-results-header">
      <%# TODO: i18n %>
      <span class="results-count"><%= @results.total %> <%= "result".pluralize(@results.total) %></span>
      <% if current_user&.admin? && @results.respond_to?(:search_mode) %>
        <div class="search-debug-header">
          <span class="debug-badge"><%= @results.search_mode %></span>
          <% if @results.similarity_threshold %>
            <span class="debug-stat">
              <span class="debug-label">Threshold</span>
              <span class="debug-value"><%= @results.similarity_threshold %></span>
            </span>
          <% end %>
        </div>
      <% end %>
    </div>

    <ul class="question-list">
      <% @results.hits.each do |hit| %>
        <% source = hit.source %>
        <% is_article = source["type"] == "article" %>
        <% item = is_article ? source["article"] : source["question"] %>
        <li class="question-item search-result <%= 'article-result' if is_article %>">
          <div class="search-result-stats">
            <% if is_article %>
              <div class="stat article-indicator">
                <span class="stat-icon">üìÑ</span>
                <span class="stat-label">article</span>
              </div>
            <% else %>
              <div class="stat">
                <span class="stat-number <%= item["vote_score"].to_i.positive? ? 'positive' : '' %><%= item["vote_score"].to_i.negative? ? 'negative' : '' %>">
                  <%= item["vote_score"] || 0 %>
                </span>
                <%# TODO: i18n %>
                <span class="stat-label">votes</span>
              </div>
              <div class="stat <%= source["answer_count"].to_i.positive? ? 'has-answers' : '' %> <%= item["has_correct_answer"] ? 'has-correct' : '' %>">
                <span class="stat-number"><%= source["answer_count"] || 0 %></span>
                <%# TODO: i18n %>
                <span class="stat-label">answers</span>
              </div>
              <div class="stat">
                <span class="stat-number"><%= item["views_count"] || 0 %></span>
                <%# TODO: i18n %>
                <span class="stat-label">views</span>
              </div>
            <% end %>
          </div>

          <div class="search-result-content">
            <div class="question-title">
              <% if is_article %>
                <%= link_to item["title"], article_path(item["slug"]) %>
              <% else %>
                <%= link_to item["title"], question_path(item["slug"]) %>
              <% end %>
            </div>
            <% if item["body"].present? %>
              <div class="search-result-excerpt">
                <%= truncate(strip_tags(item["body"]), length: 200) %>
              </div>
            <% end %>

            <div class="search-result-meta">
              <% if source["space"] %>
                <span class="space"><%= link_to source["space"]["name"], space_path(source["space"]["slug"]) %></span>
              <% end %>

              <% if source["tags"].present? %>
                <span class="tags">
                  <% source["tags"].each do |tag| %>
                    <%= link_to tag, search_path(tags: [tag]), class: "tag" %>
                  <% end %>
                </span>
              <% end %>

              <% if source["author"] %>
                <%# TODO: i18n %>
                <span>by <%= link_to source["author"]["username"], user_path(source["author"]["username"]) %></span>
              <% end %>

              <%# TODO: i18n %>
              <span><%= time_ago_in_words(Time.parse(item["created_at"])) %> ago</span>
            </div>

            <% if current_user&.admin? && @results.respond_to?(:search_mode) && @results.search_mode.present? %>
              <div class="search-debug-scores">
                <% if @results.search_mode == :vector %>
                  <span class="debug-score" title="Vector similarity score">
                    <span class="debug-label">Similarity</span>
                    <% if hit.vector_score %>
                      <span class="debug-similarity <%= @results.similarity_threshold && hit.vector_score >= @results.similarity_threshold ? 'above' : '' %>">
                        <%= number_with_precision(hit.vector_score, precision: 3) %>
                      </span>
                    <% else %>
                      <span class="debug-value debug-none">--</span>
                    <% end %>
                  </span>
                  <span class="debug-score" title="Vector search rank">
                    <span class="debug-label">Rank</span>
                    <% if hit.vector_rank %>
                      <span class="debug-value">#<%= hit.vector_rank %></span>
                    <% else %>
                      <span class="debug-value debug-none">--</span>
                    <% end %>
                  </span>
                <% elsif @results.search_mode == :keyword %>
                  <span class="debug-score" title="Keyword search (PostgreSQL FTS)">
                    <span class="debug-label">FTS</span>
                    <span class="debug-value">match</span>
                  </span>
                <% end %>
              </div>
            <% end %>
          </div>
        </li>
      <% end %>
    </ul>

    <% if @results.total_pages > 1 %>
      <div class="search-pagination">
        <% if @results.page > 1 %>
          <%= link_to "Previous", search_path(q: @query, space: @space&.slug, user: @user&.username, tags: @tags, sort: @sort, page: @results.page - 1), class: "btn btn-secondary btn-small" %>
        <% end %>
        <%# TODO: i18n %>
        <span class="page-info">Page <%= @results.page %> of <%= @results.total_pages %></span>
        <% if @results.page < @results.total_pages %>
          <%= link_to "Next", search_path(q: @query, space: @space&.slug, user: @user&.username, tags: @tags, sort: @sort, page: @results.page + 1), class: "btn btn-secondary btn-small" %>
        <% end %>
      </div>
    <% end %>
  <% elsif @query.present? || @space.present? || @user.present? || @tags.any? %>
    <div class="empty-state">
      <%# TODO: i18n %>
      <p>No results found. Try different search terms or filters.</p>
    </div>
  <% else %>
    <div class="empty-state">
      <%# TODO: i18n %>
      <p>Enter a search term to find questions.</p>
    </div>
  <% end %>
</div>

<style>
/* AI Answer Panel */
.ai-answer-panel {
  background: linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%);
  border: 1px solid var(--primary);
  border-radius: 8px;
  padding: 1rem 1.25rem;
  margin-bottom: 1.5rem;
}

.ai-answer-header {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 0.75rem;
}

.ai-answer-icon {
  font-size: 1.25rem;
}

.ai-answer-title {
  font-weight: 600;
  color: var(--text-primary);
}

.ai-answer-badge {
  font-size: 0.7rem;
  padding: 0.15rem 0.4rem;
  background: var(--primary);
  color: white;
  border-radius: 4px;
  text-transform: uppercase;
  font-weight: 600;
}

.ai-answer-content-wrapper {
  position: relative;
  max-height: 300px;
  overflow: hidden;
  transition: max-height 0.3s ease-out;
}

.ai-answer-content-wrapper.expanded {
  max-height: none;
}

.ai-answer-fade {
  display: none;
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 60px;
  background: linear-gradient(to bottom, transparent, #f4f7ff);
  pointer-events: none;
}

.ai-answer-content-wrapper:not(.expanded) .ai-answer-fade.visible {
  display: block;
}

.ai-answer-expand {
  display: none;
  margin-top: 0.75rem;
  padding: 0.5rem 1rem;
  background: #3584e4;
  color: #ffffff;
  border: 1px solid #2a6fc9;
  border-radius: 4px;
  font-size: 0.85rem;
  font-weight: 500;
  cursor: pointer;
  transition: background 0.2s;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.ai-answer-expand:hover {
  background: #1a5fb4;
}

.ai-answer-content {
  color: var(--text-primary);
  line-height: 1.6;
}

.ai-answer-loading {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  color: var(--text-secondary);
}

.loading-dots {
  display: flex;
  gap: 4px;
}

.loading-dots span {
  width: 8px;
  height: 8px;
  background: var(--primary);
  border-radius: 50%;
  animation: bounce 1.4s ease-in-out infinite;
}

.loading-dots span:nth-child(1) { animation-delay: 0s; }
.loading-dots span:nth-child(2) { animation-delay: 0.2s; }
.loading-dots span:nth-child(3) { animation-delay: 0.4s; }

@keyframes bounce {
  0%, 80%, 100% { transform: scale(0.6); opacity: 0.5; }
  40% { transform: scale(1); opacity: 1; }
}

.ai-answer-text {
  margin-bottom: 1rem;
}

.ai-answer-text p {
  margin: 0 0 0.75rem 0;
}

.ai-answer-text p:last-child {
  margin-bottom: 0;
}

.ai-answer-sources {
  margin-top: 1rem;
  padding-top: 0.75rem;
  border-top: 1px solid rgba(0, 0, 0, 0.1);
}

.ai-sources-label {
  font-size: 0.8rem;
  font-weight: 600;
  color: var(--text-secondary);
  margin-bottom: 0.5rem;
}

.ai-source-list {
  display: flex;
  flex-direction: column;
  gap: 0.4rem;
}

.ai-source-item {
  display: flex;
  align-items: flex-start;
  gap: 0.5rem;
  font-size: 0.875rem;
}

.ai-source-number {
  font-size: 0.8rem;
  font-weight: 600;
  color: var(--primary, #3584e4);
  flex-shrink: 0;
  min-width: 1.5rem;
}

.ai-source-type {
  font-size: 0.7rem;
  padding: 0.1rem 0.35rem;
  background: var(--bg-secondary);
  border-radius: 3px;
  color: var(--text-secondary);
  text-transform: uppercase;
  flex-shrink: 0;
}

.ai-source-link {
  color: var(--primary);
  text-decoration: none;
}

.ai-source-link:hover {
  text-decoration: underline;
}

.ai-answer-error {
  color: var(--text-secondary);
  font-style: italic;
}

.ai-answer-no-result {
  color: var(--text-secondary);
}

.ai-general-warning {
  display: flex;
  align-items: flex-start;
  gap: 0.5rem;
  padding: 0.75rem 1rem;
  margin-bottom: 1rem;
  background: #fff3cd;
  border: 1px solid #ffc107;
  border-radius: 6px;
  color: #856404;
  font-size: 0.9rem;
  line-height: 1.4;
}

.ai-warning-icon {
  flex-shrink: 0;
  font-size: 1.1rem;
}

.ai-warning-text {
  font-weight: 500;
}

.ai-citation-link {
  color: var(--primary, #3584e4);
  text-decoration: none;
  white-space: nowrap;
  margin: 0 1px;
}

.ai-citation-link:hover {
  text-decoration: underline;
}

.ai-citation-link sup {
  font-size: 0.75em;
  font-weight: 600;
}

.ai-citation-icon {
  vertical-align: super;
  margin-left: 1px;
  opacity: 0.7;
}

.ai-citation-link:hover .ai-citation-icon {
  opacity: 1;
}
</style>

<script>
(function() {
  const RENDER_MARKDOWN_PATH = '<%= markdown_preview_path %>';
  const AI_ANSWER_PATH = '<%= search_ai_answer_path %>';

  function initAiAnswer() {
    const panel = document.getElementById('ai-answer-panel');
    if (!panel) return;
    if (panel.dataset.loaded) return;
    panel.dataset.loaded = 'true';

    const query = panel.dataset.query;
    const space = panel.dataset.space;
    const contentEl = panel.querySelector('.ai-answer-content');

    if (!query) {
      panel.style.display = 'none';
      return;
    }

    const params = new URLSearchParams();
    params.append('q', query);
    if (space) params.append('space', space);

    fetch(AI_ANSWER_PATH, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
        'Accept': 'application/json'
      },
      body: params
    })
    .then(response => response.json())
    .then(data => {
      if (data.answer) {
        renderAnswer(data, contentEl);
      } else {
        contentEl.innerHTML = '<div class="ai-answer-no-result">No AI answer available for this query.</div>';
      }
    })
    .catch(error => {
      console.error('AI Answer error:', error);
      contentEl.innerHTML = '<div class="ai-answer-error">Unable to generate AI answer.</div>';
    });
  }

  function renderAnswer(data, contentEl) {
    // Use server-side markdown rendering for consistent styling
    const markdownParams = new URLSearchParams();
    markdownParams.append('text', data.answer);

    fetch(RENDER_MARKDOWN_PATH, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
        'Accept': 'application/json'
      },
      body: markdownParams
    })
    .then(response => response.json())
    .then(markdownData => {
      let html = '';
      if (!data.from_knowledge_base) {
        html += renderGeneralKnowledgeWarning();
      }
      // Convert inline citations [1], [2] to clickable links
      const processedHtml = convertInlineCitations(markdownData.html, data.sources);
      html += '<div class="ai-answer-text markdown-body">' + processedHtml + '</div>';
      html += renderSources(data.sources);
      contentEl.innerHTML = html;
      checkOverflow(contentEl);
    })
    .catch(error => {
      // Fallback to raw text if markdown rendering fails
      console.error('Markdown render error:', error);
      let html = '';
      if (!data.from_knowledge_base) {
        html += renderGeneralKnowledgeWarning();
      }
      html += '<div class="ai-answer-text">' + escapeHtml(data.answer) + '</div>';
      html += renderSources(data.sources);
      contentEl.innerHTML = html;
      checkOverflow(contentEl);
    });
  }

  function convertInlineCitations(html, sources) {
    if (!sources || sources.length === 0) return html;

    // Build a map of citation number to source info
    const sourceMap = {};
    sources.forEach(function(source, index) {
      // Use source.number if provided, otherwise use index + 1
      const num = source.number || (index + 1);
      sourceMap[num] = source;
    });

    // Replace [1], [2], etc. with clickable superscript links
    return html.replace(/\[(\d+)\]/g, function(match, num) {
      const source = sourceMap[parseInt(num, 10)];
      if (!source) return match; // Keep original if no matching source

      const path = source.type === 'Article' ? '/articles/' : '/questions/';
      const url = path + (source.slug || source.id);
      const title = escapeHtml(source.title || 'Source ' + num);

      return '<a href="' + url + '" class="ai-citation-link" title="' + title + '" target="_blank">' +
        '<sup>[' + num + ']</sup>' +
        '<svg class="ai-citation-icon" viewBox="0 0 16 16" width="12" height="12">' +
        '<path fill="currentColor" d="M4.5 3.5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-3a.5.5 0 0 1 1 0v3a2 2 0 0 1-2 2h-8a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h3a.5.5 0 0 1 0 1h-3z"/>' +
        '<path fill="currentColor" d="M9 1.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 .5.5v5a.5.5 0 0 1-1 0V2.707l-5.146 5.147a.5.5 0 0 1-.708-.708L13.293 2H9.5a.5.5 0 0 1-.5-.5z"/>' +
        '</svg>' +
        '</a>';
    });
  }

  function renderGeneralKnowledgeWarning() {
    return '<div class="ai-general-warning">' +
      '<span class="ai-warning-icon">‚ö†Ô∏è</span>' +
      '<span class="ai-warning-text">This answer is from the AI\'s general knowledge, not from your organization\'s knowledge base. Double-check this answer before relying on it.</span>' +
      '</div>';
  }

  function renderSources(sources) {
    if (!sources || sources.length === 0) return '';

    let html = '<div class="ai-answer-sources">';
    html += '<div class="ai-sources-label">Sources</div>';
    html += '<div class="ai-source-list">';

    sources.forEach(function(source, index) {
      const num = source.number || (index + 1);
      const path = source.type === 'Article' ? '/articles/' : '/questions/';
      const slug = source.slug || source.id;
      html += '<div class="ai-source-item">';
      html += '<span class="ai-source-number">[' + num + ']</span>';
      html += '<span class="ai-source-type">' + escapeHtml(source.type) + '</span>';
      html += '<a href="' + path + slug + '" class="ai-source-link" target="_blank">' + escapeHtml(source.title) + '</a>';
      html += '</div>';
    });

    html += '</div></div>';
    return html;
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function checkOverflow(contentEl) {
    const wrapper = contentEl.closest('.ai-answer-content-wrapper');
    const expandBtn = wrapper.parentElement.querySelector('.ai-answer-expand');
    const fadeEl = wrapper.querySelector('.ai-answer-fade');

    // Check if content overflows the max-height
    if (contentEl.scrollHeight > wrapper.clientHeight) {
      expandBtn.style.display = 'inline-block';
      fadeEl.classList.add('visible');
    }
  }

  function initExpandButton() {
    document.addEventListener('click', function(e) {
      const btn = e.target.closest('.ai-answer-expand');
      if (!btn) return;

      const panel = btn.closest('.ai-answer-panel');
      const wrapper = panel.querySelector('.ai-answer-content-wrapper');

      if (wrapper.classList.contains('expanded')) {
        wrapper.classList.remove('expanded');
        btn.textContent = 'Show more';
      } else {
        wrapper.classList.add('expanded');
        btn.textContent = 'Show less';
      }
    });
  }

  document.addEventListener('DOMContentLoaded', initAiAnswer);
  document.addEventListener('turbo:load', initAiAnswer);
  initExpandButton();
})();
</script>
