<% content_for :title, "Profile Settings" %>

<div class="settings-page">
  <div class="settings-header">
    <h1>Profile Settings</h1>
    <p class="settings-description">Update your display name and preferences.</p>
  </div>

  <%= form_with model: @user, url: settings_profile_path, method: :patch, class: "settings-form" do |f| %>
    <% if @user.errors.any? %>
      <div class="form-errors">
        <h3><%= pluralize(@user.errors.count, "error") %> prevented your profile from being saved:</h3>
        <ul>
          <% @user.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <div class="form-section">
      <h2>Basic Information</h2>

      <div class="form-group">
        <%= f.label :full_name, "Display Name" %>
        <%= f.text_field :full_name, class: "form-input", placeholder: "Your display name" %>
        <p class="form-hint">This is how your name appears to other users.</p>
      </div>

      <div class="form-group">
        <%= f.label :timezone, "Timezone" %>
        <%= f.time_zone_select :timezone, nil, { default: @user.timezone || "UTC" }, class: "form-input" %>
        <p class="form-hint">Used to display times in your local timezone.</p>
      </div>
    </div>

    <div class="form-section">
      <h2>Avatar</h2>

      <div class="form-group avatar-upload">
        <div class="current-avatar">
          <% if @user.respond_to?(:avatar) && @user.avatar.attached? %>
            <%= image_tag @user.avatar, class: "avatar-preview" %>
          <% else %>
            <div class="avatar-placeholder">
              <%= @user.display_name.first.upcase %>
            </div>
          <% end %>
        </div>
        <%= f.label :avatar, "Upload new avatar" %>
        <%= f.file_field :avatar, accept: "image/png,image/jpeg,image/gif,image/webp", class: "form-input" %>
        <p class="form-hint">Recommended size: 200x200 pixels. Max 2MB. PNG, JPEG, GIF, or WebP.</p>
      </div>
    </div>

    <div class="form-actions">
      <%= f.submit "Save Changes", class: "btn btn-primary" %>
    </div>
  <% end %>

  <div class="form-section">
    <h2>Email Addresses</h2>

    <div class="email-list">
      <% @user_emails.each do |email| %>
        <div class="email-item">
          <div class="email-info">
            <span class="email-address"><%= email.email %></span>
            <% if email.primary? %>
              <span class="email-badge email-badge-primary">Primary</span>
            <% end %>
            <% if email.verified? %>
              <span class="email-badge email-badge-verified">Verified</span>
            <% else %>
              <span class="email-badge email-badge-unverified">Unverified</span>
            <% end %>
          </div>
          <div class="email-actions">
            <% unless email.verified? %>
              <%= button_to "Resend verification",
                  resend_verification_settings_profile_path(email_id: email.id),
                  method: :post,
                  class: "btn btn-small btn-secondary",
                  data: { turbo_confirm: "Send verification email to #{email.email}?" } %>
            <% end %>
            <% if email.verified? && !email.primary? %>
              <%= button_to "Make primary",
                  set_primary_email_settings_profile_path(email_id: email.id),
                  method: :post,
                  class: "btn btn-small btn-secondary" %>
            <% end %>
            <% unless email.primary? %>
              <%= button_to "Remove",
                  remove_email_settings_profile_path(email_id: email.id),
                  method: :delete,
                  class: "btn btn-small btn-danger",
                  data: { turbo_confirm: "Remove #{email.email} from your account?" } %>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>

    <div class="add-email-form">
      <h3>Add Email Address</h3>
      <%= form_with url: add_email_settings_profile_path, method: :post, class: "inline-form" do %>
        <div class="form-group inline">
          <%= email_field_tag :email, nil, placeholder: "Enter email address", class: "form-input", required: true %>
          <%= submit_tag "Add Email", class: "btn btn-secondary" %>
        </div>
      <% end %>
      <p class="form-hint">A verification email will be sent to confirm ownership.</p>
    </div>
  </div>
</div>
